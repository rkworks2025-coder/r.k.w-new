<script>
// --- 追加: URL → 入力初期化 ---
function applyParamsFromURL(){
  const sp = new URL(location.href).searchParams;
  const q = k => sp.get(k) || "";
  if (document.querySelector('[name="station"]') && sp.has('station'))
    document.querySelector('[name="station"]').value = q('station');
  if (document.querySelector('[name="model"]') && sp.has('model'))
    document.querySelector('[name="model"]').value   = q('model');
  // 巡回アプリ側のキーが plate or plate_full か両対応
  const plate = sp.get('plate_full') || sp.get('plate') || "";
  if (document.querySelector('[name="plate_full"]') && plate)
    document.querySelector('[name="plate_full"]').value = plate;
}

// --- 追加: 車両ごとの保存キー ---
function buildKey(plate_full, station){
  const p = (plate_full||"").replace(/\s+/g,"");
  const s = (station||"").replace(/\s+/g,"");
  return `tirelog_${p}_${s}`;
}

// --- 追加: 結果表示（既存UIに合わせて整形） ---
function renderResult(p){
  // 会社アプリの入力順に合わせた行
  const lines = [
    `${p.tread_rf} ${p.pre_rf} ${p.dot_rf}   RF`,
    `${p.tread_lf} ${p.pre_lf} ${p.dot_lf}   LF`,
    `${p.tread_lr} ${p.pre_lr} ${p.dot_lr}   LR`,
    `${p.tread_rr} ${p.pre_rr} ${p.dot_rr}   RR`,
    '',
    p.savedAt || nowJST()
  ].join('\n');

  // ★ ステーション名を最上段に追加
  document.getElementById('res_header').textContent =
    `${p.station||''}\n${p.plate_full||''}\n${p.model||''}`;

  document.getElementById('res_times').innerHTML =
    `解錠　${p.unlock||'--:--'}<br>施錠　${p.lock||'--:--'}`;

  document.getElementById('res_lines').textContent = lines;

  // 既存の画面切替（そのまま）
  document.getElementById('form').style.display = 'none';
  document.getElementById('resultCard').style.display = 'block';
  window.scrollTo({top:0, behavior:'smooth'});
}

// --- 追加: 保存済みがあれば自動復元（同一車両のみ） ---
function tryRestoreFromLocal(){
  const station = document.querySelector('[name="station"]')?.value || '';
  const plate   = document.querySelector('[name="plate_full"]')?.value || '';
  if (!station || !plate) return;
  const saved = localStorage.getItem(buildKey(plate, station));
  if (!saved) return;
  try {
    const p = JSON.parse(saved);
    renderResult(p);
  } catch(_) {}
}

// 起動時：URL反映→あれば復元（UIは変えない）
document.addEventListener('DOMContentLoaded', ()=>{
  applyParamsFromURL();
  tryRestoreFromLocal();
});
</script>
